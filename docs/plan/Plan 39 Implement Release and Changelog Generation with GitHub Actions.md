# Plan 39: Implement Release and Changelog Generation with GitHub Actions

## Task Analysis

### Main Objective
Implement an automated release and changelog generation system using GitHub Actions with semantic-release and conventional commits. This enables automated versioning, changelog creation, and GitHub releases triggered by pushing version tags.

### Identified Dependencies
- **Existing (already configured):**
  - `commitlint.config.js` - enforces conventional commits
  - `.husky/commit-msg` - validates commit messages
  - `.github/workflows/ci.yml` - CI pipeline
  - Version sync in 3 locations: `package.json`, `app.json`, `utils/version.js`

- **To be installed:**
  - `semantic-release` - core automation engine
  - `@semantic-release/changelog` - generates CHANGELOG.md
  - `@semantic-release/git` - commits version changes back to repo
  - `@semantic-release/github` - creates GitHub releases
  - `@semantic-release/exec` - runs custom commands for multi-file version sync

### System Impact
| File | Impact |
|------|--------|
| `package.json` | Add devDependencies, release script, version managed by semantic-release |
| `app.json` | `version.name` updated automatically (code remains manual) |
| `utils/version.js` | `APP_VERSION` constant updated automatically |
| `.github/workflows/release.yml` | New workflow file |
| `CHANGELOG.md` | New file, auto-generated |
| `.releaserc.json` | New config file for semantic-release |

---

## Chosen Approach

### Proposed Solution
Use **semantic-release** with a carefully selected plugin chain to handle the multi-file version synchronization requirement. The exec plugin will run a custom Node.js script to update `app.json` and `utils/version.js` after semantic-release updates `package.json`.

### Justification for Simplicity
1. **Leverages existing infrastructure** - commitlint already enforces conventional commits
2. **Single source of truth** - `package.json` version drives all other version updates
3. **Tag-based trigger** - matches user's workflow preference
4. **No npm publishing** - GitHub Releases only, reducing complexity
5. **Reusable version sync script** - can be tested independently

### Components to be Modified/Created

| Component | Action | Purpose |
|-----------|--------|---------|
| `package.json` | Modify | Add dependencies and release script |
| `.releaserc.json` | Create | semantic-release configuration |
| `scripts/sync-version.js` | Create | Syncs version to app.json and utils/version.js |
| `.github/workflows/release.yml` | Create | GitHub Actions release workflow |
| `CHANGELOG.md` | Create (auto) | Generated by semantic-release |

---

## Implementation Steps

### Step 1: Install semantic-release Dependencies (Subtask 39.1)

**Files to modify:** `package.json`

**Dependencies to install:**
```bash
npm install --save-dev semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/exec
```

**Validation:**
- [ ] All dependencies appear in `devDependencies` section
- [ ] `npm list semantic-release` shows installed version
- [ ] No peer dependency warnings

---

### Step 2: Create Version Sync Script (Subtask 39.2)

**Files to create:** `scripts/sync-version.js`

**Purpose:** Reads version from `package.json` and updates `app.json` (version.name only) and `utils/version.js`.

**Implementation:**
```javascript
// scripts/sync-version.js
import { readFileSync, writeFileSync } from 'fs'
import { fileURLToPath } from 'url'
import { dirname, join } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const rootDir = join(__dirname, '..')

// Read version from package.json
const packageJson = JSON.parse(readFileSync(join(rootDir, 'package.json'), 'utf8'))
const version = packageJson.version

// Update app.json (only version.name)
const appJsonPath = join(rootDir, 'app.json')
const appJson = JSON.parse(readFileSync(appJsonPath, 'utf8'))
appJson.app.version.name = version
writeFileSync(appJsonPath, JSON.stringify(appJson, null, 2) + '\n')

// Update utils/version.js
const versionFilePath = join(rootDir, 'utils/version.js')
const versionFileContent = `/**
 * App version constants
 * Keep in sync with app.json > app.version.name
 */

export const APP_VERSION = '${version}'
`
writeFileSync(versionFilePath, versionFileContent)

console.log(`Synced version ${version} to app.json and utils/version.js`)
```

**Validation:**
- [ ] Script runs without errors: `node scripts/sync-version.js`
- [ ] `app.json` version.name updated correctly
- [ ] `utils/version.js` APP_VERSION updated correctly
- [ ] Original formatting preserved

---

### Step 3: Create semantic-release Configuration (Subtask 39.2)

**Files to create:** `.releaserc.json`

**Configuration:**
```json
{
  "branches": ["main"],
  "plugins": [
    [
      "@semantic-release/commit-analyzer",
      {
        "preset": "conventionalcommits",
        "releaseRules": [
          { "type": "feat", "release": "minor" },
          { "type": "fix", "release": "patch" },
          { "type": "perf", "release": "patch" },
          { "type": "docs", "release": false },
          { "type": "style", "release": false },
          { "type": "refactor", "release": "patch" },
          { "type": "test", "release": false },
          { "type": "chore", "release": false },
          { "breaking": true, "release": "major" }
        ]
      }
    ],
    [
      "@semantic-release/release-notes-generator",
      {
        "preset": "conventionalcommits",
        "presetConfig": {
          "types": [
            { "type": "feat", "section": "Features" },
            { "type": "fix", "section": "Bug Fixes" },
            { "type": "perf", "section": "Performance" },
            { "type": "refactor", "section": "Code Refactoring" }
          ]
        }
      }
    ],
    [
      "@semantic-release/changelog",
      {
        "changelogFile": "CHANGELOG.md",
        "changelogTitle": "# Changelog\n\nAll notable changes to this project will be documented in this file."
      }
    ],
    [
      "@semantic-release/npm",
      {
        "npmPublish": false
      }
    ],
    [
      "@semantic-release/exec",
      {
        "prepareCmd": "node scripts/sync-version.js"
      }
    ],
    [
      "@semantic-release/git",
      {
        "assets": ["package.json", "package-lock.json", "app.json", "utils/version.js", "CHANGELOG.md"],
        "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
      }
    ],
    [
      "@semantic-release/github",
      {
        "draftRelease": false,
        "addReleases": "bottom"
      }
    ]
  ]
}
```

**Key Configuration Decisions:**
| Setting | Value | Rationale |
|---------|-------|-----------|
| `branches` | `["main"]` | Only main branch triggers releases |
| `npmPublish` | `false` | No npm registry publishing |
| `exec.prepareCmd` | `node scripts/sync-version.js` | Syncs version to app.json and utils/version.js |
| `git.assets` | 5 files | All version-related files committed |
| `git.message` | `[skip ci]` | Prevents recursive CI runs |

**Validation:**
- [ ] `.releaserc.json` created in root directory
- [ ] JSON is valid (no syntax errors)
- [ ] Branch restriction set to main only

---

### Step 4: Update package.json Scripts (Subtask 39.2)

**Files to modify:** `package.json`

**Add to scripts section:**
```json
{
  "scripts": {
    "release": "semantic-release",
    "release:dry": "semantic-release --dry-run"
  }
}
```

**Validation:**
- [ ] `npm run release -- --dry-run` executes without errors
- [ ] Dry run shows expected version bump calculations

---

### Step 5: Create GitHub Actions Release Workflow (Subtask 39.3)

**Files to create:** `.github/workflows/release.yml`

**Workflow Configuration:**
```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-24-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-24-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Verify main branch
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            BRANCH=$(git branch -r --contains ${{ github.sha }} | grep -o 'origin/main' | head -1)
            if [[ "$BRANCH" != "origin/main" ]]; then
              echo "Error: Tags must be created from main branch"
              exit 1
            fi
            echo "Tag is from main branch, proceeding with release"
          fi

      - name: Run tests
        run: npm run test

      - name: Run lint
        run: npm run lint

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run release
```

**Workflow Behavior:**
1. Triggers on tag push matching `v*` pattern
2. Verifies tag was created from main branch
3. Runs tests and lint checks
4. Executes semantic-release
5. Creates GitHub Release with changelog

**Validation:**
- [ ] Workflow file created in `.github/workflows/`
- [ ] YAML syntax is valid
- [ ] Permissions correctly set for release creation

---

### Step 6: Create Initial CHANGELOG.md (Subtask 39.5)

**Files to create:** `CHANGELOG.md`

**Initial Content:**
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.0.0] - 2025-02-25

### Added
- Initial release of Padel Buddy
- Padel match score tracking for Amazfit watches
- Support for GTR-3 and GTS-3 devices
- Match history storage and viewing
- Multi-language support (English, Portuguese, Spanish)
```

**Note:** After first automated release, this file will be managed by semantic-release.

**Validation:**
- [ ] CHANGELOG.md exists in root directory
- [ ] Follows Keep a Changelog format

---

### Step 7: Dry-Run Verification (Subtask 39.5)

**Command:**
```bash
npm run release:dry
```

**Expected Output:**
```
[Semantic release]: This run was triggered on branch: main
[Semantic release]: The next release version is 1.1.0
[Semantic release]: Release type: minor
[Semantic release]: Analysis of 5 commits found: feat, fix, etc.
```

**Validation:**
- [ ] Dry-run completes without errors
- [ ] Shows correct version calculation based on commits
- [ ] Lists files that would be modified
- [ ] No npm publish step (correctly disabled)

---

### Step 8: End-to-End Test Procedure (Subtask 39.5)

**Prerequisites:**
- All previous steps completed
- Working on main branch
- Clean working directory

**Test Procedure:**

1. **Create a feature commit:**
   ```bash
   echo "// test" >> utils/version.js
   git add .
   git commit -m "feat: test feature for release verification"
   ```

2. **Trigger dry-run:**
   ```bash
   npm run release:dry
   ```
   - Verify: Shows version bump to 1.1.0

3. **Create and push tag:**
   ```bash
   git tag v1.1.0
   git push origin main --tags
   ```

4. **Monitor GitHub Actions:**
   - Navigate to Actions tab in GitHub
   - Verify release workflow runs successfully
   - Check that GitHub Release is created
   - Verify CHANGELOG.md is updated

5. **Verify version sync:**
   ```bash
   git pull origin main
   cat package.json | grep version
   cat app.json | grep -A1 version
   cat utils/version.js | grep APP_VERSION
   ```
   - All three files should show 1.1.0

6. **Cleanup (optional):**
   ```bash
   git reset --hard HEAD~1
   git tag -d v1.1.0
   git push origin :refs/tags/v1.1.0
   git push origin main --force
   ```

**Validation:**
- [ ] GitHub Actions workflow triggers on tag push
- [ ] Release completes without errors
- [ ] GitHub Release created with correct version
- [ ] CHANGELOG.md updated with release notes
- [ ] All 3 version files updated consistently

---

## Validation

### Success Criteria

| # | Criterion | Verification Method |
|---|-----------|---------------------|
| 1 | semantic-release and plugins installed | `npm list semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/exec` |
| 2 | package.json has release scripts | `grep -A2 '"release"' package.json` |
| 3 | release config updates all 3 version files | Review `.releaserc.json` git.assets |
| 4 | release.yml workflow exists and valid | `grep -l release .github/workflows/*.yml` |
| 5 | CHANGELOG.md exists | `test -f CHANGELOG.md` |
| 6 | commitlint enforces conventional commits | Already verified (existing) |
| 7 | Tags create GitHub releases | E2E test in Step 8 |
| 8 | Version consistency across files | `grep version package.json app.json utils/version.js` |
| 9 | Dry-run shows expected changes | `npm run release:dry` |
| 10 | No regressions in QA | `npm run complete-check` passes |

### Checkpoints

#### Pre-Implementation
- [ ] Current branch is clean (`git status`)
- [ ] On main branch or feature branch
- [ ] All existing tests pass (`npm run test`)
- [ ] Lint passes (`npm run lint`)

#### During Implementation
- [ ] Each dependency installed successfully
- [ ] Scripts created with correct syntax
- [ ] Configuration files are valid JSON/YAML
- [ ] No TypeScript/ESLint errors

#### Post-Implementation
- [ ] `npm run complete-check` passes
- [ ] Dry-run shows correct version calculation
- [ ] All files committed with proper message
- [ ] Documentation updated (this plan)

### Rollback Notes

If Step 8 (E2E test) fails:
1. Delete the tag: `git tag -d v1.1.0 && git push origin :refs/tags/v1.1.0`
2. Reset to previous commit: `git reset --hard HEAD~1`
3. Force push if needed: `git push origin main --force`
4. Delete GitHub Release manually via UI

If semantic-release misbehaves:
1. Check `GITHUB_TOKEN` permissions
2. Review `.releaserc.json` configuration
3. Run with `--debug` flag: `npm run release -- --debug`

---

## Files Summary

### Files to Create
| File | Purpose |
|------|---------|
| `.releaserc.json` | semantic-release configuration |
| `scripts/sync-version.js` | Multi-file version synchronization |
| `.github/workflows/release.yml` | GitHub Actions release workflow |
| `CHANGELOG.md` | Release history (initial version) |

### Files to Modify
| File | Changes |
|------|---------|
| `package.json` | Add devDependencies, add release scripts |

---

## Dependency Graph

```
Step 1: Install Dependencies
    │
    ├──► Step 2: Create sync-version.js
    │
    ├──► Step 3: Create .releaserc.json
    │
    └──► Step 4: Update package.json scripts
              │
              └──► Step 5: Create release.yml
                        │
                        └──► Step 6: Create CHANGELOG.md
                                  │
                                  └──► Step 7: Dry-run verification
                                            │
                                            └──► Step 8: E2E test
```

---

## Notes

1. **Version Code in app.json:** The `version.code` field remains manual as requested. Developers must increment this before major releases for app store submissions.

2. **Tag Format:** Only tags matching `v*` pattern (e.g., `v1.0.0`, `v1.1.0`) will trigger releases.

3. **Branch Protection:** The workflow verifies that tags are created from the main branch to prevent accidental releases.

4. **Skip CI:** Release commits include `[skip ci]` to prevent recursive CI runs.

5. **Breaking Changes:** Commits with `BREAKING CHANGE:` footer or `!` after type will trigger major version bumps.
